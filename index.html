<!DOCTYPE html>
<html>
  <head>
    <title>WebRTC P2P ç´”éŸ³è¨Šé€šè©±æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 20px;
      }
      video {
        width: 300px;
        height: 200px;
        background: #eee;
        border: 1px solid #ccc;
        margin: 10px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        color: white;
      }
      #startBtn {
        background-color: #4caf50;
      } /* ç¶ è‰² */
      #callBtn {
        background-color: #2196f3;
      } /* è—è‰² */
      #hangupBtn {
        background-color: #f44336;
      } /* ç´…è‰² */
    </style>
  </head>
  <body>
    <h1>WebRTC P2P ç´”éŸ³è¨Šé€šè©±æ¸¬è©¦</h1>
    <p>ç”±æ–¼è¨­å‚™æ²’æœ‰é¡é ­ï¼Œé€šè©±å·²æ”¹ç‚ºç´”éŸ³è¨Šæ¨¡å¼ (Audio-only Call)ã€‚</p>

    <div>
      <h2>æœ¬æ©Ÿ (Local) - éŸ³è¨Š</h2>
      <video id="localVideo" autoplay style="display: none"></video>
      <p>éº¥å…‹é¢¨å·²å•Ÿå‹• (ç„¡ç•«é¢)</p>
    </div>

    <div>
      <h2>é ç«¯ (Remote) - éŸ³è¨Š</h2>
      <video id="remoteVideo" autoplay style="display: none"></video>
      <p>é ç«¯éŸ³è¨Šæ’­æ”¾ä¸­ (ç„¡ç•«é¢)</p>
    </div>

    <button id="startBtn">1. é–‹å§‹å–å¾—åª’é«” (Get Media)</button>
    <button id="callBtn" disabled>2. å»ºç«‹é€£ç·š (Call)</button>
    <button id="hangupBtn" disabled>3. é—œé–‰é€šè©± (Hang Up)</button>

    <script>
      // ** é‡è¦ï¼šå°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨ ngrok è¦–çª—ä¸­é¡¯ç¤ºçš„ HTTPS ç¶²å€ï¼Œä¸¦ä½¿ç”¨ wss:// å”å®š **
      const SIGNALING_SERVER_URL =
        "wss://superelegantly-ectogenetic-sienna.ngrok-free.dev";

      const STUN_SERVER = "stun:stun.l.google.com:19302"; // å…è²»çš„å…¬å…± STUN ä¼ºæœå™¨
      const configuration = {
        iceServers: [{ urls: STUN_SERVER }],
      };

      let localStream;
      let localPeerConnection;
      let ws;

      // ç²å–æ‰€æœ‰éœ€è¦çš„ HTML å…ƒç´ 
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const startBtn = document.getElementById("startBtn");
      const callBtn = document.getElementById("callBtn");
      const hangupBtn = document.getElementById("hangupBtn"); // æ–°å¢ï¼šç²å–æ›æ–·æŒ‰éˆ•

      // è¨­ç½®äº‹ä»¶è™•ç†å™¨
      startBtn.onclick = startMedia;
      callBtn.onclick = callUser;
      hangupBtn.onclick = hangUp; // æ–°å¢ï¼šæ›æ–·æŒ‰éˆ•ç¶å®š hangUp å‡½å¼

      // --- 1. å–å¾—æœ¬æ©Ÿåª’é«” (startMedia) ---
      async function startMedia() {
        try {
          // *** ä¿®æ­£ï¼šåƒ…è«‹æ±‚éŸ³è¨Šï¼Œä¸éœ€è¦è¦–è¨Š (video: false) ***
          localStream = await navigator.mediaDevices.getUserMedia({
            video: false,
            audio: true,
          });

          // ç”±æ–¼æ˜¯ç´”éŸ³è¨Šï¼Œå°‡ä¸²æµè³¦äºˆ localVideo å…ƒç´  (é›–ç„¶éš±è—ï¼Œä½†ç¢ºä¿ç€è¦½å™¨å•Ÿå‹•éŸ³è¨Šè™•ç†)
          localVideo.srcObject = localStream;

          console.log(
            "æˆåŠŸç²å–éŸ³è¨Šä¸²æµï¼éŸ³è»Œæ•¸é‡:",
            localStream.getAudioTracks().length
          );

          // è¨­ç½®æŒ‰éˆ•ç‹€æ…‹
          startBtn.disabled = true;
          callBtn.disabled = false;
          hangupBtn.disabled = true;

          connectSignalingServer();
        } catch (e) {
          console.error("ç„¡æ³•å–å¾—åª’é«”:", e);
          alert(
            "è«‹ç¢ºèªæ‚¨æ­£åœ¨ HTTPS/localhost ç’°å¢ƒä¸‹é‹è¡Œï¼Œä¸¦å…è¨±ä½¿ç”¨éº¥å…‹é¢¨ã€‚éŒ¯èª¤ï¼š" +
              e.name
          );
        }
      }

      // --- 2. é€£ç·šä¿¡ä»¤ä¼ºæœå™¨ (connectSignalingServer) ---
      function connectSignalingServer() {
        // å¦‚æœ WebSocket å·²ç¶“é–‹å•Ÿï¼Œå‰‡ä¸å†é‡æ–°é€£ç·š
        if (ws && ws.readyState === WebSocket.OPEN) return;

        ws = new WebSocket(SIGNALING_SERVER_URL);

        ws.onopen = () => {
          console.log("æˆåŠŸé€£ç·šåˆ°ä¿¡ä»¤ä¼ºæœå™¨ (ngrok WSS)");
        };

        ws.onmessage = async (event) => {
          const message = JSON.parse(event.data);

          // --- è™•ç† Offer è¨Šæ¯ (è¢«å‘¼å«æ–¹) ---
          if (message.type === "offer") {
            console.log(
              "æ”¶åˆ° SDP Offerï¼Œé–‹å§‹åˆå§‹åŒ– PeerConnection ä¸¦å›è¦† Answer"
            );

            // ğŸ’¡ ä¿®æ­£ï¼šå¦‚æœè¢«å‘¼å«æ–¹å°šæœªé»æ“Š Call (localPeerConnection == undefined)ï¼Œå‰‡åŸ·è¡Œåˆå§‹åŒ–ã€‚
            if (!localPeerConnection) {
              // åŸ·è¡Œ callUser() å‡½å¼ä¸­ï¼Œèˆ‡é€£ç·šåˆå§‹åŒ–ç›¸é—œçš„é‚è¼¯
              // æ³¨æ„ï¼šæ­¤æ™‚ callUser() ä¸æœƒè‡ªå‹•åŸ·è¡Œå»ºç«‹ Offer çš„æ­¥é©Ÿ
              await initializePeerConnection();
            }

            // è¨­ç½®é ç«¯æè¿°ä¸¦å‰µå»º Answer
            await localPeerConnection.setRemoteDescription(
              new RTCSessionDescription(message)
            );
            const answer = await localPeerConnection.createAnswer();
            await localPeerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify(answer));
          } else if (message.type === "answer") {
            // --- è™•ç† Answer è¨Šæ¯ (å‘¼å«æ–¹) ---
            await localPeerConnection.setRemoteDescription(
              new RTCSessionDescription(message)
            );
          } else if (message.type === "candidate") {
            // --- è™•ç† ICE Candidate è¨Šæ¯ ---
            try {
              if (
                localPeerConnection &&
                localPeerConnection.signalingState !== "closed"
              ) {
                await localPeerConnection.addIceCandidate(
                  new RTCIceCandidate(message.candidate)
                );
              }
            } catch (e) {
              console.error("æ–°å¢ ICE Candidate å¤±æ•—:", e);
            }
          } else if (message.type === "hangup") {
            // --- æ–°å¢ï¼šè™•ç†å°æ–¹æ›æ–·çš„è¨Šæ¯ ---
            console.log("æ”¶åˆ°å°æ–¹æ›æ–·é€šè©±çš„è¨Šæ¯");
            // åŸ·è¡Œæ›æ–·é‚è¼¯ï¼Œä½†ä¸ç™¼é€ hangup ä¿¡ä»¤ï¼Œé¿å…è¿´åœˆ
            hangUp(false);
            alert("é€šè©±å·²è¢«å°æ–¹é—œé–‰ã€‚");
          }
        };

        ws.onclose = () => console.log("ä¿¡ä»¤ä¼ºæœå™¨æ–·é–‹é€£ç·š");
        ws.onerror = (e) => console.error("WebSocket éŒ¯èª¤:", e);
      }

      // --- 3. æ ¸å¿ƒåˆå§‹åŒ–é‚è¼¯ (è¢«å‘¼å«æ–¹æ”¶åˆ° Offer æ™‚ä¹ŸæœƒåŸ·è¡Œ) ---
      async function initializePeerConnection() {
        localPeerConnection = new RTCPeerConnection(configuration);

        // 1. è™•ç†æœ¬æ©Ÿåª’é«”æµ (å°‡éŸ³è¨Šè»Œé“æ–°å¢åˆ° PeerConnection)
        localStream.getTracks().forEach((track) => {
          localPeerConnection.addTrack(track, localStream);
        });

        // 2. è™•ç†é ç«¯åª’é«”æµ (æ¥æ”¶éŸ³è¨Šä¸¦æ’­æ”¾)
        localPeerConnection.ontrack = (event) => {
          if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            console.log("æ¥æ”¶åˆ°é ç«¯éŸ³è¨Šæµ");
          }
        };

        // 3. æ”¶é›†ä¸¦ç™¼é€ ICE Candidate
        localPeerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            // é€éä¿¡ä»¤ä¼ºæœå™¨å°‡ Candidate ç™¼é€çµ¦é ç«¯
            ws.send(
              JSON.stringify({
                type: "candidate",
                candidate: event.candidate,
              })
            );
          }
        };

        // 4. ç›£è½é€£ç·šç‹€æ…‹ï¼Œå•Ÿç”¨æ›æ–·æŒ‰éˆ•
        localPeerConnection.oniceconnectionstatechange = () => {
          const state = localPeerConnection.iceConnectionState;
          console.log(`ICE é€£ç·šç‹€æ…‹è®Šæ›´: ${state}`);

          if (state === "connected" || state === "completed") {
            // é€£ç·šæˆåŠŸå»ºç«‹
            hangupBtn.disabled = false;
            callBtn.disabled = true;
          } else if (state === "failed" || state === "closed") {
            // é€£ç·šå¤±æ•—æˆ–é—œé–‰ï¼Œé‡ç½® UI (ä½†ä¸å½±éŸ¿æœ¬åœ°åª’é«”æµ)
            if (localStream) {
              callBtn.disabled = false;
            } else {
              startBtn.disabled = false;
            }
            hangupBtn.disabled = true;
          }
        };
      }

      // --- 4. å»ºç«‹é€£ç·š (callUser - å‘¼å«æ–¹å°ˆç”¨) ---
      async function callUser() {
        // åŸ·è¡Œåˆå§‹åŒ–ï¼Œé€™æœƒè¨­ç½®å¥½æ‰€æœ‰çš„ç›£è½å™¨
        await initializePeerConnection();

        // å»ºç«‹ Offer (é€™æ˜¯å‘¼å«æ–¹æ‰åšçš„)
        try {
          const offer = await localPeerConnection.createOffer();
          await localPeerConnection.setLocalDescription(offer);

          // é€éä¿¡ä»¤ä¼ºæœå™¨å°‡ Offer ç™¼é€çµ¦é ç«¯
          ws.send(JSON.stringify(offer));
          console.log("å·²ç™¼é€ SDP Offer");

          callBtn.disabled = true; // ç™¼é€ Offer å¾Œç¦ç”¨ Call æŒ‰éˆ•
        } catch (e) {
          console.error("å»ºç«‹ Offer å¤±æ•—:", e);
        }
      }

      // --- 5. é—œé–‰é€šè©± (hangUp å‡½å¼) ---
      /**
       * é—œé–‰é€šè©±ã€é‡‹æ”¾è³‡æºä¸¦é‡ç½®ç‹€æ…‹ã€‚
       * @param {boolean} sendSignal æ˜¯å¦ç™¼é€ 'hangup' ä¿¡ä»¤çµ¦å°æ–¹ (é è¨­ç‚º true)
       */
      function hangUp(sendSignal = true) {
        console.log("æ­£åœ¨é—œé–‰é€šè©±...");

        // 1. é—œé–‰ RTCPeerConnection é€£ç·š
        if (localPeerConnection) {
          localPeerConnection.close();
          localPeerConnection = null;
        }

        // 2. åœæ­¢æœ¬åœ°åª’é«”è»Œé“ï¼Œé‡‹æ”¾éº¥å…‹é¢¨ (ä¿ç•™ startMedia çš„å•Ÿå‹•ç‹€æ…‹)
        if (localStream) {
          // localStream.getTracks().forEach((track) => track.stop()); // è®“éº¥å…‹é¢¨ä¿æŒé–‹å•Ÿï¼Œæ–¹ä¾¿ä¸‹æ¬¡å¿«é€Ÿé€£ç·š
          // localStream = null;
          // åƒ…æ–·é–‹é€£ç·šï¼Œä¿ç•™æœ¬åœ°åª’é«”æµ
        }

        // 3. åœæ­¢é ç«¯åª’é«”ï¼ˆè®“é ç«¯éŸ³è¨Šåœæ­¢æ’­æ”¾ï¼‰
        if (remoteVideo) {
          if (remoteVideo.srcObject) {
            remoteVideo.srcObject.getTracks().forEach((track) => track.stop());
            remoteVideo.srcObject = null;
          }
        }

        // 4. é€šçŸ¥å°æ–¹æ›æ–·
        if (sendSignal && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "hangup" }));
        }

        // 5. é‡ç½®æŒ‰éˆ•ç‹€æ…‹ (å‡è¨­ localStream ä»ç„¶æ˜¯é–‹å•Ÿçš„)
        startBtn.disabled = true;
        callBtn.disabled = false; // å¯ä»¥é‡æ–°ç™¼èµ·é€£ç·š
        hangupBtn.disabled = true;

        console.log("é€šè©±å·²é—œé–‰ï¼Œå¯ä»¥é‡æ–°å»ºç«‹é€£ç·šã€‚");
      }
    </script>
  </body>
</html>
